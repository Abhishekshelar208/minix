<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="minix">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Minix</title>
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }
    
    #loading {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #loading-text {
      margin-top: 20px;
      color: #6b7280;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
    <div id="loading-text">Loading Minix...</div>
  </div>

  <!-- Layer 1: HTML Version Control & Auto-Update System -->
  <script>
    // ==================== VERSION CONTROL CONFIGURATION ====================
    const APP_VERSION = '1.0.0';  // Update this version number when deploying
    const AUTO_UPDATE_ENABLED = false;  // Set to true in production
    const VERSION_KEY = 'minix_app_version';
    const LAST_RELOAD_KEY = 'minix_last_reload';
    const RELOAD_COOLDOWN = 10000; // 10 seconds cooldown to prevent loops

    // ==================== AUTO-UPDATE LOGIC ====================
    function checkAndUpdateVersion() {
      console.log('üîç Checking app version...');
      console.log('üì± Current version:', APP_VERSION);
      
      if (!AUTO_UPDATE_ENABLED) {
        console.log('‚ö†Ô∏è Auto-update is disabled (development mode)');
        localStorage.setItem(VERSION_KEY, APP_VERSION);
        return;
      }

      const storedVersion = localStorage.getItem(VERSION_KEY);
      console.log('üíæ Stored version:', storedVersion || 'none');

      // Check if version has changed
      if (storedVersion && storedVersion !== APP_VERSION) {
        console.log('üîÑ Version mismatch detected!');
        console.log('   Old:', storedVersion);
        console.log('   New:', APP_VERSION);

        // Check cooldown to prevent reload loops
        const lastReload = localStorage.getItem(LAST_RELOAD_KEY);
        const now = Date.now();

        if (lastReload && (now - parseInt(lastReload)) < RELOAD_COOLDOWN) {
          console.log('‚è≥ Reload cooldown active, skipping update');
          localStorage.setItem(VERSION_KEY, APP_VERSION);
          return;
        }

        console.log('üßπ Clearing caches and storage...');
        performHardUpdate();
      } else {
        console.log('‚úÖ Version is up to date');
        localStorage.setItem(VERSION_KEY, APP_VERSION);
      }
    }

    async function performHardUpdate() {
      try {
        // Store reload timestamp
        localStorage.setItem(LAST_RELOAD_KEY, Date.now().toString());
        
        // 1. Clear all caches
        console.log('üóëÔ∏è Clearing caches...');
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(
            cacheNames.map(cacheName => {
              console.log('   Deleting cache:', cacheName);
              return caches.delete(cacheName);
            })
          );
        }

        // 2. Unregister all service workers
        console.log('üîå Unregistering service workers...');
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          await Promise.all(
            registrations.map(registration => {
              console.log('   Unregistering:', registration.scope);
              return registration.unregister();
            })
          );
        }

        // 3. Clear localStorage except version info
        console.log('üßπ Clearing storage...');
        const versionToKeep = APP_VERSION;
        const lastReloadToKeep = localStorage.getItem(LAST_RELOAD_KEY);
        localStorage.clear();
        localStorage.setItem(VERSION_KEY, versionToKeep);
        localStorage.setItem(LAST_RELOAD_KEY, lastReloadToKeep);

        // 4. Force hard reload
        console.log('üîÑ Performing hard reload...');
        window.location.reload(true);
      } catch (error) {
        console.error('‚ùå Error during hard update:', error);
        // Force reload anyway
        localStorage.setItem(VERSION_KEY, APP_VERSION);
        window.location.reload(true);
      }
    }

    // Run version check on page load
    checkAndUpdateVersion();

    // ==================== SERVICE WORKER REGISTRATION ====================
    window.addEventListener('load', async function() {
      // Register custom service worker if it exists
      if ('serviceWorker' in navigator) {
        try {
          // First, try to register custom service worker
          const registration = await navigator.serviceWorker.register(
            '/service-worker.js',
            { scope: '/' }
          );
          
          console.log('‚úÖ Service Worker registered:', registration.scope);
          
          // Listen for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            console.log('üîÑ Service Worker update found');
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'activated') {
                console.log('‚úÖ New Service Worker activated');
                // Optionally notify user about update
              }
            });
          });
        } catch (error) {
          console.log('‚ÑπÔ∏è Custom service worker not available, using Flutter default');
          console.log('   Error:', error.message);
        }
      }
    });
  </script>

  <!-- Flutter Bootstrap -->
  <script src="flutter_bootstrap.js" async></script>
  
  <!-- Remove loading screen when Flutter is ready -->
  <script>
    window.addEventListener('flutter-first-frame', function() {
      const loading = document.getElementById('loading');
      if (loading) {
        loading.style.display = 'none';
      }
    });
  </script>
</body>
</html>
